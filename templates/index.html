<!DOCTYPE html>
<html>
<head>
    <title>Resources</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<header style="display:flex;align-items:center;gap:12px;padding:12px;">
    <h1 style="margin:0">Resources</h1>
    <input id="search-input" type="search" placeholder="Search title or description..." aria-label="Search resources" style="margin-left:12px; padding:6px 10px; border:1px solid #ccc; border-radius:6px; flex:1; max-width:420px;">
    <button id="theme-toggle" class="btn btn--grey" title="Toggle theme" style="margin-left:8px;">Toggle theme</button>

    <button id="filter-open" class="btn btn--grey" style="margin-left:8px;">Filter</button>
    <button id="create-open" class="btn btn--blue" style="margin-left:8px;">Create</button>
    <button id="quick-filter-drone" class="btn btn--grey quick-filter" data-type="DRONE" title="Show Drones" style="margin-left:8px;"><img src="{{ url_for('static', filename='Drone.png') }}" alt="Drone"></button>
    <button id="quick-filter-gcs" class="btn btn--grey quick-filter" data-type="GCS" title="Show GCS" style="margin-left:8px;"><img src="{{ url_for('static', filename='GCS.png') }}" alt="GCS"></button>
</header>

<div class="grid">
    {% for r in resources %}
    <div class="card status-{{ r.status|default('UNDEFINED') }}" data-type="{{ r.category }}" data-id="{{ r.id }}" data-hidden="0">
        {% if r.image_filename %}
            <img src="{{ url_for('static', filename='uploads/' + r.image_filename) }}" alt="{{ r.title }}">
        {% else %}
            <div class="no-image">No image</div>
        {% endif %}
        <h3>
            {{ r.title }}
            {% if r.description %}
            <span class="info-icon" tabindex="0" role="button" aria-label="Show description">
                i
                <span class="tooltip-text">{{ (r.description|replace('<br>', '\n')|replace('<br/>','\n')|replace('<br />','\n'))|e }}</span>
            </span>
            {% endif %}
        </h3>
        <p class="category">{{ r.category }}</p>
        {% if r.attributes %}
            <ul class="attributes">
            {% for k, v in r.attributes.items() %}
                <li><strong>{{ k }}:</strong> {{ v }}</li>
            {% endfor %}
            </ul>
        {% endif %}
        <div class="card-actions">
            <div class="card-actions-left">
                <a href="{{ url_for('edit', resource_id=r.id) }}" class="btn btn--blue edit-btn" data-id="{{ r.id }}" data-title='{{ r.title|e }}' data-description='{{ r.description|e }}' data-category='{{ r.category }}' data-status='{{ r.status }}' data-attrs='{{ r.attributes|tojson }}' data-image='{{ r.image_filename if r.image_filename else "" }}'>Edit</a>
            </div>
            <div class="card-actions-right" aria-hidden="true">
                {% if r.status == 'NOK' %}
                    <img class="status-icon status-nok" src="{{ url_for('static', filename='Warning.png') }}" alt="NOK" title="NOK">
                {% elif r.status == 'NEEDFIX' %}
                    <img class="status-icon status-needfix" src="{{ url_for('static', filename='Tools.png') }}" alt="Need fix" title="Need fix">
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- add-card: create new resource shortcut (opens modal) -->
    <a href="#" id="add-card-open" class="card add-card" role="button" tabindex="0" title="Create new resource" aria-label="Create new resource">
        <div class="add-plus">+</div>
    </a>
</div>

<!-- tooltip -->
<script>
// Toggle tooltip on click (useful on touch devices) and close when clicking elsewhere
document.addEventListener('click', function(e){
    const icon = e.target.closest('.info-icon');
    if (icon) {
        icon.classList.toggle('tooltip-open');
    } else {
        document.querySelectorAll('.info-icon.tooltip-open').forEach(ic => ic.classList.remove('tooltip-open'));
    }
});
// Close tooltips on Escape
document.addEventListener('keydown', function(e){
    if (e.key === 'Escape') {
        document.querySelectorAll('.info-icon.tooltip-open').forEach(ic => ic.classList.remove('tooltip-open'));
    }
});
</script>

<!-- Query -->
<script>
(function(){
    const grid = document.querySelector('.grid');
    if (!grid) return;

    function adjustCardHeights(){
        const cards = Array.from(document.querySelectorAll('.grid .card'));
        if (!cards.length) return;
        // reset any previously set minHeight
        cards.forEach(c => c.style.minHeight = '');
        // group cards by their top position to equalize per row
        const rows = {};
        cards.forEach(c => {
            const top = Math.round(c.getBoundingClientRect().top);
            (rows[top] = rows[top] || []).push(c);
        });
        Object.values(rows).forEach(group => {
            if (!group.length) return;
            let maxH = 0;
            group.forEach(c => {
                const h = c.getBoundingClientRect().height;
                if (h > maxH) maxH = h;
            });
            group.forEach(c => c.style.minHeight = Math.ceil(maxH) + 'px');
        });
    }

    let resizeTimer;
    window.addEventListener('resize', ()=>{
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(adjustCardHeights, 150);
    });

    window.addEventListener('load', ()=>{
        adjustCardHeights();
        document.querySelectorAll('.grid img').forEach(img => img.addEventListener('load', adjustCardHeights));
    });

    // expose function so other scripts can call it
    window.adjustCardHeights = adjustCardHeights;
    // observe mutations in case cards are added/edited dynamically
    const obs = new MutationObserver(() => adjustCardHeights());
    obs.observe(grid, { childList: true, subtree: true });
})();
</script>

<!-- Filter modal -->
<div id="filter-modal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="filter-title">
        <h2 id="filter-title">Filters</h2>
        <div class="filter-section">
            <strong>Types</strong><br>
            {% for t in types %}
                <label><input type="checkbox" name="filter-type" value="{{ t.name }}" checked> {{ t.name }}</label><br>
            {% endfor %}
        </div>
        <div style="margin-top:12px">
            <button id="filter-apply" class="btn btn--blue">Apply</button>
            <button id="filter-reset" class="btn btn--orange" style="margin-left:8px">Reset</button>
            <button id="filter-uncheck" class="btn btn--orange" style="margin-left:8px">Uncheck</button>
            <button id="filter-close" class="btn btn--grey" style="margin-left:8px">Close</button>
        </div>
    </div>
</div>

<!-- Create modal -->
<div id="create-modal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="create-title">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
            <h2 id="create-title">Create Resource</h2>
            <div>
                <button id="create-close" class="btn btn--grey">Close</button>
            </div>
        </div>
        <div style="margin-top:8px;">
            {% include '_create_form.html' %}
        </div>
    </div>
</div>

<script>
// Filter UI logic
(function(){
    const openBtn = document.getElementById('filter-open');
    const modal = document.getElementById('filter-modal');
    const closeBtn = document.getElementById('filter-close');
    const applyBtn = document.getElementById('filter-apply');
    const resetBtn = document.getElementById('filter-reset');

    // create modal elements
    const createOpenBtn = document.getElementById('create-open');
    const createModal = document.getElementById('create-modal');
    const createCloseBtn = document.getElementById('create-close');

    if (!modal || !openBtn) return;

    function openModal(){ modal.classList.add('open'); modal.setAttribute('aria-hidden', 'false'); }
    function closeModal(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden', 'true'); }

    openBtn.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);

    // Theme toggle (persist in localStorage)
    const themeToggle = document.getElementById('theme-toggle');
    function setTheme(dark){
        if (dark) document.documentElement.classList.add('dark-mode');
        else document.documentElement.classList.remove('dark-mode');
        localStorage.setItem('theme', dark ? 'dark' : 'light');
        if (themeToggle) themeToggle.textContent = dark ? 'Dark Mode' : 'Light Mode';
    }
    // init from storage
    const stored = localStorage.getItem('theme');
    setTheme(stored === 'dark');
    if (themeToggle) themeToggle.addEventListener('click', ()=> setTheme(!document.documentElement.classList.contains('dark-mode')));

    // Quick filter buttons (toggle behavior) and visual active state
    const quickButtons = Array.from(document.querySelectorAll('.quick-filter'));
    function quickFilter(typeName){
        // determine currently checked types
        const checked = Array.from(document.querySelectorAll('input[name="filter-type"]:checked')).map(n=>n.value);
        // if this type is already the only checked one -> clear (reset to all checked)
        if (checked.length === 1 && checked[0] === typeName) {
            document.querySelectorAll('input[name="filter-type"]').forEach(cb => cb.checked = true);
        } else {
            document.querySelectorAll('input[name="filter-type"]').forEach(cb => cb.checked = (cb.value === typeName));
        }
        applyFilters();
        updateQuickFilterActive();
    }
    quickButtons.forEach(btn => btn.addEventListener('click', ()=> quickFilter(btn.dataset.type)));

    function updateQuickFilterActive(){
        // active if this button's type is the only checked type
        const checked = Array.from(document.querySelectorAll('input[name="filter-type"]:checked')).map(n=>n.value);
        quickButtons.forEach(btn => {
            if (checked.length === 1 && checked[0] === btn.dataset.type) btn.classList.add('active');
            else btn.classList.remove('active');
        });
    }
    // initialize active state on load
    updateQuickFilterActive();


    resetBtn.addEventListener('click', ()=>{
        // only affects the checkbox state (no direct application)
        document.querySelectorAll('input[name="filter-type"]').forEach(cb=>cb.checked=true);
        updateQuickFilterActive();
    });

    const uncheckBtn = document.getElementById('filter-uncheck');
    if (uncheckBtn) {
        uncheckBtn.addEventListener('click', ()=>{
            // only affects the checkbox state (no direct application)
            document.querySelectorAll('input[name="filter-type"]').forEach(cb=>cb.checked=false);
            updateQuickFilterActive();
        });
    }

    // live search: apply filters on input
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('input', ()=> applyFilters());
    }

    function applyFilters(){
        const selected = new Set(Array.from(document.querySelectorAll('input[name="filter-type"]:checked')).map(n=>n.value));
        const searchValue = (document.getElementById('search-input') ? document.getElementById('search-input').value.trim().toLowerCase() : '');
        const searchWords = searchValue ? searchValue.split(/\s+/) : [];

        // only filter resource cards, keep the add-card always visible
        document.querySelectorAll('.grid .card:not(.add-card)').forEach(card => {
            const type = card.dataset.type;
            const okType = selected.has(type);

            // gather searchable text: title and description tooltip (if present)
            const titleEl = card.querySelector('h3');
            const titleText = titleEl ? titleEl.textContent : '';
            const descEl = card.querySelector('.tooltip-text');
            const descText = descEl ? descEl.textContent : '';
            const hay = (titleText + ' ' + descText).toLowerCase();

            // any word present (OR semantics)
            let okSearch = true;
            if (searchWords.length) {
                okSearch = searchWords.some(w => w && hay.includes(w));
            }

            card.style.display = (okType && okSearch) ? '' : 'none';
        });

        // ensure add-card is always visible and placed last
        const addCard = document.querySelector('.grid .add-card');
        if (addCard) {
            addCard.style.display = '';
            addCard.remove();
            document.querySelector('.grid').appendChild(addCard);
        }
        // re-equalize heights
        if (window.adjustCardHeights) window.adjustCardHeights();
        closeModal();
    }

    applyBtn.addEventListener('click', applyFilters);

    // close when clicking outside modal content
    modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });

    // create modal: open/close and outside-click handling
    if (createModal && createOpenBtn) {
        function openCreateModal(shouldReset = true){ 
            // reset embedded form when requested so each open shows a clean slate
            const f = createModal.querySelector('form');
            if (f && shouldReset) {
                f.reset();
                // clear image preview and drop zone text
                const p = createModal.querySelector('#image-preview'); if (p) { p.src = ''; p.style.display = 'none'; }
                const dz = createModal.querySelector('#drop-zone'); if (dz) dz.textContent = 'Drop image here or click';
                // hide delete button and clear its resource id
                const deleteBtn = createModal.querySelector('#delete-btn'); if (deleteBtn) { deleteBtn.style.display = 'none'; deleteBtn.dataset.resourceId = ''; }
                // ensure submit button shows Create
                const submitBtn = f.querySelector('button[type="submit"]'); if (submitBtn) submitBtn.textContent = 'Create';
                // trigger type fields update if present
                const ev = new Event('change'); const sel = createModal.querySelector('#type-select'); if (sel) sel.dispatchEvent(ev);
            }
            createModal.classList.add('open'); createModal.setAttribute('aria-hidden', 'false'); 
            // focus first input for accessibility
            setTimeout(()=>{ const f = createModal.querySelector('input[name="title"]'); if (f) f.focus(); }, 40);
        }
        function closeCreateModal(){ createModal.classList.remove('open'); createModal.setAttribute('aria-hidden', 'true'); }
        createOpenBtn.addEventListener('click', () => openCreateModal(true));
        if (createCloseBtn) createCloseBtn.addEventListener('click', closeCreateModal);
        // intercept cancel inside the embedded form so it closes the modal instead of navigating
        const cancelCreate = createModal.querySelector('#cancel-create');
        if (cancelCreate) cancelCreate.addEventListener('click', (e) => { e.preventDefault(); closeCreateModal(); });
        createModal.addEventListener('click', (e)=>{ if (e.target === createModal) closeCreateModal(); });

        // handle add-card click: open create modal with clean form
        const addCardBtn = document.getElementById('add-card-open');
        if (addCardBtn) {
            addCardBtn.addEventListener('click', (e) => {
                e.preventDefault();
                openCreateModal(true);
            });
        }

        // handle Edit buttons: populate form, set action to /edit/:id and show delete
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function(e){
                e.preventDefault();
                const id = this.dataset.id;
                const form = createModal.querySelector('form');
                if (!form) return;
                // set form action to edit route
                form.action = '/edit/' + id;
                // set submit label
                const submitBtn = form.querySelector('button[type="submit"]'); if (submitBtn) submitBtn.textContent = 'Save';
                // populate fields
                const title = this.dataset.title || '';
                const desc = this.dataset.description || '';
                const cat = this.dataset.category || '';
                const status = this.dataset.status || '';
                form.querySelector('input[name="title"]').value = title;
                form.querySelector('textarea[name="description"]').value = desc;
                const sel = form.querySelector('select[name="category"]');
                if (sel) { sel.value = cat; sel.dispatchEvent(new Event('change')); }
                const statusSel = form.querySelector('select[name="status"]'); if (statusSel) statusSel.value = status;
                // attributes (JSON)
                let attrs = {};
                try { attrs = JSON.parse(this.getAttribute('data-attrs') || '{}'); } catch(e) { attrs = {}; }
                Object.keys(attrs).forEach(k => {
                    const el = form.querySelector('[name="'+k+'"]'); if (el) el.value = attrs[k];
                });
                // image
                const img = form.querySelector('#image-preview'); const dz = form.querySelector('#drop-zone');
                const imageName = this.dataset.image || '';
                if (img) { if (imageName) { img.src = '/static/uploads/' + imageName; img.style.display = 'block'; } else { img.src = ''; img.style.display = 'none'; } }
                if (dz) dz.textContent = imageName ? imageName : 'Drop image here or click';
                // show delete button
                const deleteBtn = form.querySelector('#delete-btn'); if (deleteBtn) { deleteBtn.style.display = 'inline-block'; deleteBtn.dataset.resourceId = id; }
                // open modal without resetting the form (we already populated it)
                openCreateModal(false);
            });
        });
    }

})();
</script>

</body>
</html>
