<form method="post" enctype="multipart/form-data" class="form-grid" action="{{ url_for('edit', resource_id=resource.id) if resource else url_for('create') }}">
    <div class="form-row">
        <label class="form-label">Title</label>
        <div class="form-control"><input type="text" name="title" value="{{ resource.title if resource else '' }}" placeholder="New Resource"></div>
    </div>

    <div class="form-row">
        <label class="form-label">Image</label>
        <div class="form-control">
            <div>
                <img id="image-preview" {% if resource and resource.image_filename %}src="{{ url_for('static', filename='uploads/' + resource.image_filename) }}" style="max-width:200px;display:block;margin-bottom:8px;"{% else %}src="" style="display:none;max-width:200px;margin-bottom:8px;"{% endif %} alt="image preview">
            </div>
            <div id="drop-zone">Drop image here or click</div>
            <input type="file" name="image" id="image-input" hidden>
        </div>
    </div>

    <div class="form-row">
        <label class="form-label">Description</label>
        <div class="form-control"><textarea name="description">{{ resource.description if resource }}</textarea></div>
    </div>

    <div class="form-row">
        <label class="form-label">Type</label>
        <div class="form-control">
            <select name="category" id="type-select">
                {% for t in types %}
                    <option value="{{ t.name }}" {% if resource and resource.category == t.name %}selected{% endif %}>{{ t.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="form-row">
        <label class="form-label">Type Options</label>
        <div class="form-control">
            <div id="type-fields">
                {% for t in types %}
                    <div class="type-block" data-type="{{ t.name }}" style="display:none;">
                        {% for field in t.fields %}
                            <div style="margin-bottom:8px;">
                                <label>{{ field|capitalize }}</label>
                                <input type="text" name="{{ field }}" value="{{ attrs.get(field) if attrs and attrs.get(field) }}">
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="form-row">
        <label class="form-label">Status</label>
        <div class="form-control">
            <select name="status">
                {% for s in states %}
                    <option value="{{ s }}" {% if status_val==s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <script>
        // type fields handling (works when this partial is included on page)
        (function(){
            const typeSelect = document.getElementById("type-select");
            if (!typeSelect) return;
            function updateTypeFields() {
                const selected = typeSelect.value;
                document.querySelectorAll('#type-fields .type-block').forEach(block => {
                    const isVisible = block.dataset.type === selected;
                    block.style.display = isVisible ? 'block' : 'none';
                    block.querySelectorAll('input, select, textarea').forEach(el => {
                        if (isVisible) el.disabled = false; else { try { el.value = ''; } catch(e){}; el.disabled = true; }
                    });
                });
            }
            typeSelect.addEventListener('change', updateTypeFields);
            updateTypeFields();
        })();
    </script>

    <div class="form-row">
        <label class="form-label"></label>
        <div class="form-control form-actions">
            <button type="submit" class="btn btn--blue">{{ 'Save' if resource else 'Create' }}</button>
            <!-- delete button is present but hidden by default; will be shown in edit mode -->
            <button type="button" class="btn btn--red" id="delete-btn" style="margin-left:8px; {% if not resource %}display:none;{% endif %}" {% if resource %}data-resource-id="{{ resource.id }}"{% endif %}>Delete</button>
            <a id="cancel-create" href="{{ url_for('index') }}" class="btn btn--grey" style="margin-left:8px;">Cancel</a>
        </div>
    </div>

<script>
// unified delete handler: instant AJAX deletion without confirmation, keeps filters active
(function(){
    const btn = document.getElementById('delete-btn');
    if (!btn) return;
    btn.addEventListener('click', function(){
        const id = btn.dataset.resourceId || '{{ resource.id if resource else '' }}';
        if (!id) return;
        // DELETE instantly via AJAX without confirmation
        fetch('/delete/' + id, { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    // if we're in the modal on the index page, find and remove the card, close modal
                    const card = document.querySelector('.grid .card[data-id="' + id + '"]');
                    if (card) {
                        card.remove();
                        // re-equalize card heights after removal
                        if (window.adjustCardHeights) window.adjustCardHeights();
                    }
                    // close the modal if open
                    const modal = document.getElementById('create-modal');
                    if (modal && modal.classList.contains('open')) {
                        modal.classList.remove('open');
                        modal.setAttribute('aria-hidden', 'true');
                    }
                    // if we're on the standalone edit page, redirect to index
                    if (window.location.pathname.includes('/edit/')) {
                        window.location.href = '/';
                    }
                } else {
                    alert('Failed to delete resource');
                }
            })
            .catch(err => {
                console.error('Delete failed:', err);
                alert('Error deleting resource');
            });
    });
})();
</script>
</form>

<script>
// image drop/preview handling for the partial
(function(){
    const dropZone = document.getElementById("drop-zone");
    const input = document.getElementById("image-input");
    const imgPreview = document.getElementById("image-preview");
    if (!dropZone || !input) return;
    dropZone.addEventListener('click', () => input.click());
    input.addEventListener('change', () => {
        const f = input.files && input.files[0];
        if (f) { if (imgPreview) { imgPreview.src = URL.createObjectURL(f); imgPreview.style.display = 'block'; } dropZone.textContent = f.name; }
    });
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('hover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('hover'));
    dropZone.addEventListener('drop', e => {
        e.preventDefault();
        if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) {
            input.files = e.dataTransfer.files;
            const f = input.files[0];
            if (f && imgPreview) { imgPreview.src = URL.createObjectURL(f); imgPreview.style.display = 'block'; }
            dropZone.textContent = f.name;
        }
    });
})();
</script>

{% if resource %}
<script>
// delete handler for edit context
(function(){
    const btn = document.getElementById('delete-btn');
    if (!btn) return;
    btn.addEventListener('click', function(){
        if (!confirm('Delete this resource?')) return;
        const f = document.createElement('form'); f.method='POST'; f.action='{{ url_for("delete", resource_id=resource.id) }}'; document.body.appendChild(f); f.submit();
    });
})();
</script>
{% endif %}