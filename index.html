<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Resource Dashboard</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background:#f5f5f5; }
h2 { margin-bottom: 10px; }

select { margin-bottom: 20px; padding:5px; font-size:16px; }

/* Card grid */
#resourceList { display:flex; flex-wrap:wrap; gap:10px; }
.card {
    flex: 1 1 200px;
    background:white;
    border-radius:8px;
    padding:10px;
    cursor:pointer;
    box-shadow:0 2px 5px rgba(0,0,0,0.2);
    transition: transform 0.1s;
}
.card:hover { transform: scale(1.02); }

/* Status colors */
.status-0 { border-left: 5px solid green; }
.status-1 { border-left: 5px solid orange; }
.status-2 { border-left: 5px solid red; }

/* Add new card style */
.add-card {
    display:flex;
    justify-content:center;
    align-items:center;
    font-size:24px;
    color: #555;
    font-weight:bold;
    background:#eee;
    border: 2px dashed #aaa;
}

/* Modal overlay */
#modalOverlay {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.5);
    display:none;
    justify-content:center;
    align-items:center;
}
#modal {
    background:white;
    padding:20px;
    border-radius:8px;
    width:400px;
    max-height:90vh;
    overflow-y:auto;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

#modal h3 { margin-top:0; }
#modal label { display:block; margin-top:10px; font-weight: bold; }
#modal input, #modal textarea { width:100%; padding:5px; margin-top:3px; }
#modal button { margin-top:15px; padding:8px 12px; font-size:14px; }
</style>
</head>
<body>

<h2>Resource Dashboard</h2>
<label>Resource Type:</label>
<select id="resourceType"></select>

<div id="resourceList"></div>

<!-- Modal for editing/creating -->
<div id="modalOverlay">
    <div id="modal">
        <h3 id="modalTitle">Edit Resource</h3>
        <form id="modalForm"></form>
        <button onclick="saveResource()">Save</button>
        <button onclick="closeModal()">Cancel</button>
        <button onclick="deleteResourceModal()" id="deleteBtn" style="background:red;color:white;">Delete</button>
    </div>
</div>

<script>
const API_BASE = "http://localhost:5000";
let resourceTypes = {};
let currentResource = null;
let isNew = false;

// --- Fetch resource types ---
async function fetchResourceTypes() {
    const res = await fetch(`${API_BASE}/resource-types`);
    resourceTypes = await res.json();

    const select = document.getElementById("resourceType");
    select.innerHTML = "";
    Object.keys(resourceTypes).forEach(type => {
        const option = document.createElement("option");
        option.value = type;
        option.textContent = type;
        select.appendChild(option);
    });
    loadResources();
}

document.getElementById("resourceType").addEventListener("change", () => loadResources());

// --- Load and render resources ---
async function loadResources() {
    const type = document.getElementById("resourceType").value;
    const res = await fetch(`${API_BASE}/resources?type=${type}`);
    const resources = await res.json();

    const container = document.getElementById("resourceList");
    container.innerHTML = "";

    // Add "+" card first
    const addCard = document.createElement("div");
    addCard.className = "card add-card";
    addCard.innerHTML = "+";
    addCard.onclick = () => openModal(null); // null = new resource
    container.appendChild(addCard);

    // Existing resources
    resources.forEach(r => {
        const card = document.createElement("div");
        card.className = `card status-${r.status}`;
        card.innerHTML = `
            <strong>${r.name}</strong><br>
            Type: ${r.type}<br>
            Status: ${r.status}<br>
        `;
        card.onclick = () => openModal(r);
        container.appendChild(card);
    });
}

// --- Open modal ---
function openModal(resource) {
    currentResource = resource;
    isNew = !resource;
    const form = document.getElementById("modalForm");
    form.innerHTML = "";

    document.getElementById("modalTitle").textContent = isNew ? "New Resource" : "Edit Resource";
    document.getElementById("deleteBtn").style.display = isNew ? "none" : "inline-block";

    const type = document.getElementById("resourceType").value;

    // Core fields
    ["name","status","description"].forEach(f=>{
        const label = document.createElement("label");
        label.textContent = f.charAt(0).toUpperCase()+f.slice(1);
        form.appendChild(label);

        const input = document.createElement(f==="description"?"textarea":"input");
        input.name = f;
        if(f==="status") input.type="number";

        if(!isNew && resource) input.value = resource[f];
        form.appendChild(input);
    });

    // Attributes
    const typeFields = resourceTypes[type];

    typeFields.forEach(f => {
        if (["name", "status", "description"].includes(f.name)) return;

        const label = document.createElement("label");
        label.textContent = f.name;
        form.appendChild(label);

        const input = document.createElement("input");
        input.name = f.name;

        // Use field.type from API to choose input type
        if (f.type === "bool") {
            input.type = "checkbox";
            if (!isNew && resource && resource.attributes[f.name] !== undefined)
                input.checked = resource.attributes[f.name];
        } else if (f.type === "int") {
            input.type = "number";
            if (!isNew && resource && resource.attributes[f.name] !== undefined)
                input.value = resource.attributes[f.name];
        } else {
            input.type = "text";
            if (!isNew && resource && resource.attributes[f.name] !== undefined)
                input.value = resource.attributes[f.name];
        }

        form.appendChild(input);
    });


    document.getElementById("modalOverlay").style.display="flex";
}

// --- Close modal ---
function closeModal(){
    currentResource = null;
    isNew = false;
    document.getElementById("modalOverlay").style.display="none";
}

// --- Save resource ---
async function saveResource(){
    const form = document.getElementById("modalForm");
    const payload = {type: document.getElementById("resourceType").value, attributes:{}};

    Array.from(form.elements).forEach(el=>{
        if(!el.name) return;
        if(["name","status","description"].includes(el.name)){
            if(el.name==="status") payload.status=parseInt(el.value);
            else payload[el.name]=el.value;
        } else {
            if(el.type==="checkbox") payload.attributes[el.name]=el.checked;
            else payload.attributes[el.name]=el.value;
        }
    });

    let url = `${API_BASE}/resources`;
    let method = "POST";

    if(!isNew && currentResource){
        url += `/${currentResource.id}`;
        method = "PUT";
    }

    await fetch(url,{method, headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)});
    closeModal();
    loadResources();
}

// --- Delete resource from modal ---
async function deleteResourceModal(){
    if(!currentResource) return;
    await fetch(`${API_BASE}/resources/${currentResource.id}`,{method:"DELETE"});
    closeModal();
    loadResources();
}

fetchResourceTypes();
</script>

</body>
</html>
